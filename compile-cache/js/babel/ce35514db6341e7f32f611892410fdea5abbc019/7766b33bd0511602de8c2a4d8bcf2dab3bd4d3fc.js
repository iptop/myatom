Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.checkTarget = checkTarget;
exports.recursiveViewDestroy = recursiveViewDestroy;
exports.resolveHome = resolveHome;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _atomSpacePenViews = require('atom-space-pen-views');

var _viewsDirectoryView = require('./views/directory-view');

var _viewsDirectoryView2 = _interopRequireDefault(_viewsDirectoryView);

'use babel';

var addIconToElement = undefined;

var hasProject = function hasProject() {
  return atom.project && atom.project.getPaths().length;
};
exports.hasProject = hasProject;
var multipleHostsEnabled = function multipleHostsEnabled() {
  return atom.config.get('Remote-FTP.beta.multipleHosts');
};
exports.multipleHostsEnabled = multipleHostsEnabled;
var hasOwnProperty = function hasOwnProperty(_ref) {
  var obj = _ref.obj;
  var prop = _ref.prop;
  return Object.prototype.hasOwnProperty.call(obj, prop);
};
exports.hasOwnProperty = hasOwnProperty;
var resizeCursor = process.platform === 'win32' ? 'ew-resize' : 'col-resize';
exports.resizeCursor = resizeCursor;
var splitPaths = function splitPaths(path) {
  return path.replace(/^\/+/, '').replace(/\/+$/, '').split('/');
};

exports.splitPaths = splitPaths;
var simpleSort = function simpleSort(a, b) {
  if (a.name === b.name) {
    return 0;
  }

  return a.name > b.name ? 1 : -1;
};

exports.simpleSort = simpleSort;
var simpleSortDepth = function simpleSortDepth(a, b) {
  if (a.depth === b.depth) {
    return 0;
  }

  return a.depth > b.depth ? -1 : 1;
};

exports.simpleSortDepth = simpleSortDepth;
var sortDepth = function sortDepth(a, b) {
  if (a.depth === b.depth) {
    return 0;
  }

  return a.depth > b.depth ? 1 : -1;
};

exports.sortDepth = sortDepth;
var countDepth = function countDepth(file) {
  file.depth = file.name.split('/').length;
};

exports.countDepth = countDepth;
var getObject = function getObject(_ref2) {
  var keys = _ref2.keys;
  var obj = _ref2.obj;

  if (!(keys instanceof Array)) throw new Error('keys is not an array');
  if (typeof obj !== 'object') throw new Error('obj is not an object');

  return keys.reduce(function (ret, key) {
    if (ret && hasOwnProperty({ obj: ret, prop: key })) return ret[key];
    return false;
  }, obj);
};

exports.getObject = getObject;
var setIconHandler = function setIconHandler(fn) {
  addIconToElement = fn;
};

exports.setIconHandler = setIconHandler;
var getIconHandler = function getIconHandler() {
  return addIconToElement;
};

exports.getIconHandler = getIconHandler;
var elapsedTime = function elapsedTime(milliseconds) {
  var ms = milliseconds;

  var days = Math.floor(ms / 86400000);
  ms %= 86400000;
  var hours = Math.floor(ms / 3600000);
  ms %= 3600000;
  var mins = Math.floor(ms / 60000);
  ms %= 60000;
  var secs = Math.floor(ms / 1000);
  ms %= 1000;

  return ((days ? days + 'd ' : '') + (hours ? (days && hours < 10 ? '0' : '') + hours + 'h ' : '') + (mins ? ((days || hours) && mins < 10 ? '0' : '') + mins + 'm ' : '') + (secs ? ((days || hours || mins) && secs < 10 ? '0' : '') + secs + 's ' : '')).replace(/^[dhms]\s+/, '').replace(/[dhms]\s+[dhms]/g, '').replace(/^\s+/, '').replace(/\s+$/, '') || '0s';
};

exports.elapsedTime = elapsedTime;
var separateRemoteItems = function separateRemoteItems(folder) {
  if (!folder) return false;

  var list = [];
  var filter = function filter(item) {
    if (item.name === '.' || item.name === '..') return;

    if (item.type !== 'd' && item.type !== 'l') {
      item.type = 'f';
    }

    list.push(item);
  };

  folder.forEach(filter);

  return list;
};

exports.separateRemoteItems = separateRemoteItems;
var logger = function logger(text) {
  console.log(text);
};

exports.logger = logger;
var localFilePrepare = function localFilePrepare(fileName, currentPath) {
  var file = undefined;
  var queue = undefined;

  if (fileName !== '.' && fileName !== '..') {
    var fullName = _path2['default'].join(currentPath, fileName);

    var stats = _fs2['default'].statSync(fullName);
    file = {
      name: fullName,
      size: stats.size,
      date: stats.mtime,
      type: stats.isFile() ? 'f' : 'd'
    };

    if (!stats.isFile()) {
      queue = fullName;
    }
  }

  return { file: file, queue: queue };
};

exports.localFilePrepare = localFilePrepare;
var traverseTree = function traverseTree(localPath, callback) {
  var list = [];
  var queue = [localPath];

  // search all files in localPath recursively
  while (queue.length > 0) {
    var currentPath = _path2['default'].normalize(queue.pop());

    if (!_fs2['default'].existsSync(currentPath)) {
      _fs2['default'].closeSync(_fs2['default'].openSync(currentPath, 'w'));
    }

    var filesFound = _fs2['default'].readdirSync(currentPath);

    var localFile = undefined;
    for (var i = 0; i < filesFound.length; i++) {
      localFile = localFilePrepare(filesFound[i], currentPath);
      list.push(localFile.file);

      if (localFile.queue) {
        queue.push(localFile.queue);
      }
    }
  }

  // depth counting & sorting
  list.forEach(countDepth);
  list.sort(sortDepth);

  // callback
  if (typeof callback === 'function') callback.apply(null, [list]);
};

exports.traverseTree = traverseTree;
var validateConfig = function validateConfig(data) {
  try {
    // try to parse the json
    JSON.parse(data);
    return true;
  } catch (error) {
    (function () {
      // try to extract bad syntax location from error message
      var lineNumber = -1;
      var index = undefined;
      var regex = /at position ([0-9]+)$/;
      var result = error.message.match(regex);
      if (result && result.length > 0) {
        var cursorPos = parseInt(result[1], 10);
        // count lines until syntax error position
        var tmp = data.substr(0, cursorPos);
        for (lineNumber = -1, index = 0; index !== -1; lineNumber++, index = tmp.indexOf('\n', index + 1));
      }

      // show notification
      atom.notifications.addError('Could not parse `.ftpconfig`', {
        detail: '' + error.message,
        dismissable: false
      });

      // open .ftpconfig file and mark the faulty line
      atom.workspace.open('.ftpconfig').then(function (editor) {
        if (lineNumber === -1) return; // no line number to mark

        var decorationConfig = {
          'class': 'ftpconfig_line_error'
        };

        editor.getDecorations(decorationConfig).forEach(function (decoration) {
          decoration.destroy();
        });

        var range = editor.getBuffer().clipRange([[lineNumber, 0], [lineNumber, Infinity]]);

        var marker = editor.markBufferRange(range, {
          invalidate: 'inside'
        });

        decorationConfig.type = 'line';
        editor.decorateMarker(marker, decorationConfig);
      });
    })();
  }

  // return false, as the json is not valid
  return false;
};

exports.validateConfig = validateConfig;
var resolveTree = function resolveTree(path) {
  var views = (0, _atomSpacePenViews.$)('.remote-ftp-view [data-path="' + path + '"]');

  return views.map(function (err, item) {
    return (0, _atomSpacePenViews.$)(item).view() || null;
  }).get(0);
};

exports.resolveTree = resolveTree;
var getSelectedTree = function getSelectedTree() {
  var views = (0, _atomSpacePenViews.$)('.remote-ftp-view .selected');

  return views.map(function (err, item) {
    return (0, _atomSpacePenViews.$)(item).view() || null;
  }).get();
};

exports.getSelectedTree = getSelectedTree;

function checkTarget(e) {
  var view = (0, _atomSpacePenViews.$)(e.currentTarget).view();
  var hasProjectRoot = view.hasClass('project-root');
  var hasProjectRootHeader = (0, _atomSpacePenViews.$)(e.target).hasClass('project-root-header');

  if (!view || view instanceof _viewsDirectoryView2['default'] === false) return false;
  if (hasProjectRoot && !hasProjectRootHeader) return false;

  return true;
}

function recursiveViewDestroy(view) {
  view.getItemViews().folders.forEach(function (fView) {
    recursiveViewDestroy(fView);
    fView.destroy();
  });
}

function resolveHome(path) {
  return _path2['default'].normalize(path.replace('~', _os2['default'].homedir()));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vQzovVXNlcnMvQWRtaW5pc3RyYXRvci8uYXRvbS9wYWNrYWdlcy9SZW1vdGUtRlRQL2xpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztrQkFFZSxJQUFJOzs7O2tCQUNKLElBQUk7Ozs7b0JBQ0YsTUFBTTs7OztpQ0FDTCxzQkFBc0I7O2tDQUNkLHdCQUF3Qjs7OztBQU5sRCxXQUFXLENBQUM7O0FBUVosSUFBSSxnQkFBZ0IsWUFBQSxDQUFDOztBQUVkLElBQU0sVUFBVSxHQUFHLFNBQWIsVUFBVTtTQUFTLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNO0NBQUEsQ0FBQzs7QUFDeEUsSUFBTSxvQkFBb0IsR0FBRyxTQUF2QixvQkFBb0I7U0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsQ0FBQztDQUFBLENBQUM7O0FBQ3BGLElBQU0sY0FBYyxHQUFHLFNBQWpCLGNBQWMsQ0FBSSxJQUFhO01BQVgsR0FBRyxHQUFMLElBQWEsQ0FBWCxHQUFHO01BQUUsSUFBSSxHQUFYLElBQWEsQ0FBTixJQUFJO1NBQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUM7Q0FBQSxDQUFDOztBQUMxRixJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsUUFBUSxLQUFLLE9BQU8sR0FBRyxXQUFXLEdBQUcsWUFBWSxDQUFDOztBQUMvRSxJQUFNLFVBQVUsR0FBRyxTQUFiLFVBQVUsQ0FBRyxJQUFJO1NBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0NBQUEsQ0FBQzs7O0FBRW5GLElBQU0sVUFBVSxHQUFHLFNBQWIsVUFBVSxDQUFJLENBQUMsRUFB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SyxDQUFDLEdBQUcsQ0FBQyxVQUFDLEdBQUcsRUFBRSxJQUFJO1dBQUssMEJBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSTtHQUFBLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztDQUMvRCxDQUFDOzs7O0FBRUssU0FBUyxXQUFXLENBQUMsQ0FBQyxFQUFFO0FBQzdCLE1BQU0sSUFBSSxHQUFHLDBCQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUN2QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sb0JBQW9CLEdBQUcsMEJBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDOztBQUV6RSxNQUFJLENBQUMsSUFBSSxJQUFJLElBQUksMkNBQXlCLEtBQUssS0FBSyxFQUFFLE9BQU8sS0FBSyxDQUFDO0FBQ25FLE1BQUksY0FBYyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxLQUFLLENBQUM7O0FBRTFELFNBQU8sSUFBSSxDQUFDO0NBQ2I7O0FBRU0sU0FBUyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUU7QUFDekMsTUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLLEVBQUs7QUFDN0Msd0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDNUIsU0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0dBQ2pCLENBQUMsQ0FBQztDQUNKOztBQUVNLFNBQVMsV0FBVyxDQUFDLElBQUksRUFBRTtBQUNoQyxTQUFPLGtCQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxnQkFBRyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7Q0FDeEQiLCJmaWxlIjoiZmlsZTovLy9DOi9Vc2Vycy9BZG1pbmlzdHJhdG9yLy5hdG9tL3BhY2thZ2VzL1JlbW90ZS1GVFAvbGliL2hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7ICQgfSBmcm9tICdhdG9tLXNwYWNlLXBlbi12aWV3cyc7XG5pbXBvcnQgRGlyZWN0b3J5VmlldyBmcm9tICcuL3ZpZXdzL2RpcmVjdG9yeS12aWV3JztcblxubGV0IGFkZEljb25Ub0VsZW1lbnQ7XG5cbmV4cG9ydCBjb25zdCBoYXNQcm9qZWN0ID0gKCkgPT4gYXRvbS5wcm9qZWN0ICYmIGF0b20ucHJvamVjdC5nZXRQYXRocygpLmxlbmd0aDtcbmV4cG9ydCBjb25zdCBtdWx0aXBsZUhvc3RzRW5hYmxlZCA9ICgpID0+IGF0b20uY29uZmlnLmdldCgnUmVtb3RlLUZUUC5iZXRhLm11bHRpcGxlSG9zdHMnKTtcbmV4cG9ydCBjb25zdCBoYXNPd25Qcm9wZXJ0eSA9ICh7IG9iaiwgcHJvcCB9KSA9PiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTtcbmV4cG9ydCBjb25zdCByZXNpemVDdXJzb3IgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJ2V3LXJlc2l6ZScgOiAnY29sLXJlc2l6ZSc7XG5leHBvcnQgY29uc3Qgc3BsaXRQYXRocyA9IHBhdGggPT4gcGF0aC5yZXBsYWNlKC9eXFwvKy8sICcnKS5yZXBsYWNlKC9cXC8rJC8sICcnKS5zcGxpdCgnLycpO1xuXG5leHBvcnQgY29uc3Qgc2ltcGxlU29ydCA9IChhLCBiKSA9PiB7XG4gIGlmIChhLm5hbWUgPT09IGIubmFtZSkgeyByZXR1cm4gMDsgfVxuXG4gIHJldHVybiBhLm5hbWUgPiBiLm5hbWUgPyAxIDogLTE7XG59O1xuXG5leHBvcnQgY29uc3Qgc2ltcGxlU29ydERlcHRoID0gKGEsIGIpID0+IHtcbiAgaWYgKGEuZGVwdGggPT09IGIuZGVwdGgpIHsgcmV0dXJuIDA7IH1cblxuICByZXR1cm4gYS5kZXB0aCA+IGIuZGVwdGggPyAtMSA6IDE7XG59O1xuXG5leHBvcnQgY29uc3Qgc29ydERlcHRoID0gKGEsIGIpID0+IHtcbiAgaWYgKGEuZGVwdGggPT09IGIuZGVwdGgpIHsgcmV0dXJuIDA7IH1cblxuICByZXR1cm4gYS5kZXB0aCA+IGIuZGVwdGggPyAxIDogLTE7XG59O1xuXG5leHBvcnQgY29uc3QgY291bnREZXB0aCA9IChmaWxlKSA9PiB7XG4gIGZpbGUuZGVwdGggPSBmaWxlLm5hbWUuc3BsaXQoJy8nKS5sZW5ndGg7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0T2JqZWN0ID0gKHsga2V5cywgb2JqIH0pID0+IHtcbiAgaWYgKCEoa2V5cyBpbnN0YW5jZW9mIEFycmF5KSkgdGhyb3cgbmV3IEVycm9yKCdrZXlzIGlzIG5vdCBhbiBhcnJheScpO1xuICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHRocm93IG5ldyBFcnJvcignb2JqIGlzIG5vdCBhbiBvYmplY3QnKTtcblxuICByZXR1cm4ga2V5cy5yZWR1Y2UoKHJldCwga2V5KSA9PiB7XG4gICAgaWYgKHJldCAmJiBoYXNPd25Qcm9wZXJ0eSh7IG9iajogcmV0LCBwcm9wOiBrZXkgfSkpIHJldHVybiByZXRba2V5XTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0sIG9iaik7XG59O1xuXG5leHBvcnQgY29uc3Qgc2V0SWNvbkhhbmRsZXIgPSAoZm4pID0+IHtcbiAgYWRkSWNvblRvRWxlbWVudCA9IGZuO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldEljb25IYW5kbGVyID0gKCkgPT4gYWRkSWNvblRvRWxlbWVudDtcblxuZXhwb3J0IGNvbnN0IGVsYXBzZWRUaW1lID0gKG1pbGxpc2Vjb25kcykgPT4ge1xuICBsZXQgbXMgPSBtaWxsaXNlY29uZHM7XG5cbiAgY29uc3QgZGF5cyA9IE1hdGguZmxvb3IobXMgLyA4NjQwMDAwMCk7XG4gIG1zICU9IDg2NDAwMDAwO1xuICBjb25zdCBob3VycyA9IE1hdGguZmxvb3IobXMgLyAzNjAwMDAwKTtcbiAgbXMgJT0gMzYwMDAwMDtcbiAgY29uc3QgbWlucyA9IE1hdGguZmxvb3IobXMgLyA2MDAwMCk7XG4gIG1zICU9IDYwMDAwO1xuICBjb25zdCBzZWNzID0gTWF0aC5mbG9vcihtcyAvIDEwMDApO1xuICBtcyAlPSAxMDAwO1xuXG4gIHJldHVybiAoKGRheXMgPyBgJHtkYXlzfWQgYCA6ICcnKSArXG4gICAgICAoaG91cnMgPyBgJHsoKGRheXMpICYmIGhvdXJzIDwgMTAgPyAnMCcgOiAnJykgKyBob3Vyc31oIGAgOiAnJykgK1xuICAgICAgKG1pbnMgPyBgJHsoKGRheXMgfHwgaG91cnMpICYmIG1pbnMgPCAxMCA/ICcwJyA6ICcnKSArIG1pbnN9bSBgIDogJycpICtcbiAgICAgIChzZWNzID8gYCR7KChkYXlzIHx8IGhvdXJzIHx8IG1pbnMpICYmIHNlY3MgPCAxMCA/ICcwJyA6ICcnKSArIHNlY3N9cyBgIDogJycpKVxuICAgIC5yZXBsYWNlKC9eW2RobXNdXFxzKy8sICcnKVxuICAgIC5yZXBsYWNlKC9bZGhtc11cXHMrW2RobXNdL2csICcnKVxuICAgIC5yZXBsYWNlKC9eXFxzKy8sICcnKVxuICAgIC5yZXBsYWNlKC9cXHMrJC8sICcnKSB8fCAnMHMnO1xufTtcblxuZXhwb3J0IGNvbnN0IHNlcGFyYXRlUmVtb3RlSXRlbXMgPSAoZm9sZGVyKSA9PiB7XG4gIGlmICghZm9sZGVyKSByZXR1cm4gZmFsc2U7XG5cbiAgY29uc3QgbGlzdCA9IFtdO1xuICBjb25zdCBmaWx0ZXIgPSAoaXRlbSkgPT4ge1xuICAgIGlmIChpdGVtLm5hbWUgPT09ICcuJyB8fCBpdGVtLm5hbWUgPT09ICcuLicpIHJldHVybjtcblxuICAgIGlmIChpdGVtLnR5cGUgIT09ICdkJyAmJiBpdGVtLnR5cGUgIT09ICdsJykge1xuICAgICAgaXRlbS50eXBlID0gJ2YnO1xuICAgIH1cblxuICAgIGxpc3QucHVzaChpdGVtKTtcbiAgfTtcblxuICBmb2xkZXIuZm9yRWFjaChmaWx0ZXIpO1xuXG4gIHJldHVybiBsaXN0O1xufTtcblxuZXhwb3J0IGNvbnN0IGxvZ2dlciA9ICh0ZXh0KSA9PiB7XG4gIGNvbnNvbGUubG9nKHRleHQpO1xufTtcblxuZXhwb3J0IGNvbnN0IGxvY2FsRmlsZVByZXBhcmUgPSAoZmlsZU5hbWUsIGN1cnJlbnRQYXRoKSA9PiB7XG4gIGxldCBmaWxlO1xuICBsZXQgcXVldWU7XG5cbiAgaWYgKGZpbGVOYW1lICE9PSAnLicgJiYgZmlsZU5hbWUgIT09ICcuLicpIHtcbiAgICBjb25zdCBmdWxsTmFtZSA9IFBhdGguam9pbihjdXJyZW50UGF0aCwgZmlsZU5hbWUpO1xuXG4gICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhmdWxsTmFtZSk7XG4gICAgZmlsZSA9IHtcbiAgICAgIG5hbWU6IGZ1bGxOYW1lLFxuICAgICAgc2l6ZTogc3RhdHMuc2l6ZSxcbiAgICAgIGRhdGU6IHN0YXRzLm10aW1lLFxuICAgICAgdHlwZTogc3RhdHMuaXNGaWxlKCkgPyAnZicgOiAnZCcsXG4gICAgfTtcblxuICAgIGlmICghc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgIHF1ZXVlID0gZnVsbE5hbWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHsgZmlsZSwgcXVldWUgfTtcbn07XG5cbmV4cG9ydCBjb25zdCB0cmF2ZXJzZVRyZWUgPSAobG9jYWxQYXRoLCBjYWxsYmFjaykgPT4ge1xuICBjb25zdCBsaXN0ID0gW107XG4gIGNvbnN0IHF1ZXVlID0gW2xvY2FsUGF0aF07XG5cbiAgLy8gc2VhcmNoIGFsbCBmaWxlcyBpbiBsb2NhbFBhdGggcmVjdXJzaXZlbHlcbiAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBjdXJyZW50UGF0aCA9IFBhdGgubm9ybWFsaXplKHF1ZXVlLnBvcCgpKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhjdXJyZW50UGF0aCkpIHtcbiAgICAgIGZzLmNsb3NlU3luYyhmcy5vcGVuU3luYyhjdXJyZW50UGF0aCwgJ3cnKSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZXNGb3VuZCA9IGZzLnJlYWRkaXJTeW5jKGN1cnJlbnRQYXRoKTtcblxuICAgIGxldCBsb2NhbEZpbGU7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlc0ZvdW5kLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsb2NhbEZpbGUgPSBsb2NhbEZpbGVQcmVwYXJlKGZpbGVzRm91bmRbaV0sIGN1cnJlbnRQYXRoKTtcbiAgICAgIGxpc3QucHVzaChsb2NhbEZpbGUuZmlsZSk7XG5cbiAgICAgIGlmIChsb2NhbEZpbGUucXVldWUpIHtcbiAgICAgICAgcXVldWUucHVzaChsb2NhbEZpbGUucXVldWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGRlcHRoIGNvdW50aW5nICYgc29ydGluZ1xuICBsaXN0LmZvckVhY2goY291bnREZXB0aCk7XG4gIGxpc3Quc29ydChzb3J0RGVwdGgpO1xuXG4gIC8vIGNhbGxiYWNrXG4gIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIGNhbGxiYWNrLmFwcGx5KG51bGwsIFtsaXN0XSk7XG59O1xuXG5leHBvcnQgY29uc3QgdmFsaWRhdGVDb25maWcgPSAoZGF0YSkgPT4ge1xuICB0cnkge1xuICAgIC8vIHRyeSB0byBwYXJzZSB0aGUganNvblxuICAgIEpTT04ucGFyc2UoZGF0YSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gdHJ5IHRvIGV4dHJhY3QgYmFkIHN5bnRheCBsb2NhdGlvbiBmcm9tIGVycm9yIG1lc3NhZ2VcbiAgICBsZXQgbGluZU51bWJlciA9IC0xO1xuICAgIGxldCBpbmRleDtcbiAgICBjb25zdCByZWdleCA9IC9hdCBwb3NpdGlvbiAoWzAtOV0rKSQvO1xuICAgIGNvbnN0IHJlc3VsdCA9IGVycm9yLm1lc3NhZ2UubWF0Y2gocmVnZXgpO1xuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGN1cnNvclBvcyA9IHBhcnNlSW50KHJlc3VsdFsxXSwgMTApO1xuICAgICAgLy8gY291bnQgbGluZXMgdW50aWwgc3ludGF4IGVycm9yIHBvc2l0aW9uXG4gICAgICBjb25zdCB0bXAgPSBkYXRhLnN1YnN0cigwLCBjdXJzb3JQb3MpO1xuICAgICAgZm9yIChsaW5lTnVtYmVyID0gLTEsIGluZGV4ID0gMDsgaW5kZXggIT09IC0xOyBsaW5lTnVtYmVyKyssIGluZGV4ID0gdG1wLmluZGV4T2YoJ1xcbicsIGluZGV4ICsgMSkpO1xuICAgIH1cblxuICAgIC8vIHNob3cgbm90aWZpY2F0aW9uXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdDb3VsZCBub3QgcGFyc2UgYC5mdHBjb25maWdgJywge1xuICAgICAgZGV0YWlsOiBgJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICBkaXNtaXNzYWJsZTogZmFsc2UsXG4gICAgfSk7XG5cbiAgICAvLyBvcGVuIC5mdHBjb25maWcgZmlsZSBhbmQgbWFyayB0aGUgZmF1bHR5IGxpbmVcbiAgICBhdG9tLndvcmtzcGFjZS5vcGVuKCcuZnRwY29uZmlnJykudGhlbigoZWRpdG9yKSA9PiB7XG4gICAgICBpZiAobGluZU51bWJlciA9PT0gLTEpIHJldHVybjsgLy8gbm8gbGluZSBudW1iZXIgdG8gbWFya1xuXG4gICAgICBjb25zdCBkZWNvcmF0aW9uQ29uZmlnID0ge1xuICAgICAgICBjbGFzczogJ2Z0cGNvbmZpZ19saW5lX2Vycm9yJyxcbiAgICAgIH07XG5cbiAgICAgIGVkaXRvci5nZXREZWNvcmF0aW9ucyhkZWNvcmF0aW9uQ29uZmlnKS5mb3JFYWNoKChkZWNvcmF0aW9uKSA9PiB7XG4gICAgICAgIGRlY29yYXRpb24uZGVzdHJveSgpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJhbmdlID0gZWRpdG9yLmdldEJ1ZmZlcigpLmNsaXBSYW5nZShbXG4gICAgICAgIFtsaW5lTnVtYmVyLCAwXSxcbiAgICAgICAgW2xpbmVOdW1iZXIsIEluZmluaXR5XSxcbiAgICAgIF0pO1xuXG4gICAgICBjb25zdCBtYXJrZXIgPSBlZGl0b3IubWFya0J1ZmZlclJhbmdlKHJhbmdlLCB7XG4gICAgICAgIGludmFsaWRhdGU6ICdpbnNpZGUnLFxuICAgICAgfSk7XG5cbiAgICAgIGRlY29yYXRpb25Db25maWcudHlwZSA9ICdsaW5lJztcbiAgICAgIGVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIGRlY29yYXRpb25Db25maWcpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gcmV0dXJuIGZhbHNlLCBhcyB0aGUganNvbiBpcyBub3QgdmFsaWRcbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuZXhwb3J0IGNvbnN0IHJlc29sdmVUcmVlID0gKHBhdGgpID0+IHtcbiAgY29uc3Qgdmlld3MgPSAkKGAucmVtb3RlLWZ0cC12aWV3IFtkYXRhLXBhdGg9XCIke3BhdGh9XCJdYCk7XG5cbiAgcmV0dXJuIHZpZXdzLm1hcCgoZXJyLCBpdGVtKSA9PiAkKGl0ZW0pLnZpZXcoKSB8fCBudWxsKS5nZXQoMCk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0U2VsZWN0ZWRUcmVlID0gKCkgPT4ge1xuICBjb25zdCB2aWV3cyA9ICQoJy5yZW1vdGUtZnRwLXZpZXcgLnNlbGVjdGVkJyk7XG5cbiAgcmV0dXJuIHZpZXdzLm1hcCgoZXJyLCBpdGVtKSA9PiAkKGl0ZW0pLnZpZXcoKSB8fCBudWxsKS5nZXQoKTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGVja1RhcmdldChlKSB7XG4gIGNvbnN0IHZpZXcgPSAkKGUuY3VycmVudFRhcmdldCkudmlldygpO1xuICBjb25zdCBoYXNQcm9qZWN0Um9vdCA9IHZpZXcuaGFzQ2xhc3MoJ3Byb2plY3Qtcm9vdCcpO1xuICBjb25zdCBoYXNQcm9qZWN0Um9vdEhlYWRlciA9ICQoZS50YXJnZXQpLmhhc0NsYXNzKCdwcm9qZWN0LXJvb3QtaGVhZGVyJyk7XG5cbiAgaWYgKCF2aWV3IHx8IHZpZXcgaW5zdGFuY2VvZiBEaXJlY3RvcnlWaWV3ID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlO1xuICBpZiAoaGFzUHJvamVjdFJvb3QgJiYgIWhhc1Byb2plY3RSb290SGVhZGVyKSByZXR1cm4gZmFsc2U7XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWN1cnNpdmVWaWV3RGVzdHJveSh2aWV3KSB7XG4gIHZpZXcuZ2V0SXRlbVZpZXdzKCkuZm9sZGVycy5mb3JFYWNoKChmVmlldykgPT4ge1xuICAgIHJlY3Vyc2l2ZVZpZXdEZXN0cm95KGZWaWV3KTtcbiAgICBmVmlldy5kZXN0cm95KCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZUhvbWUocGF0aCkge1xuICByZXR1cm4gUGF0aC5ub3JtYWxpemUocGF0aC5yZXBsYWNlKCd+Jywgb3MuaG9tZWRpcigpKSk7XG59XG4iXX0=